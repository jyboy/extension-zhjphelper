function updateState(){chrome.storage.local.get("isRunning",function(t){isRunning=t.isRunning,isRunning?($("#startReservationBtn").removeClass("btn-primary").addClass("btn-warning").text("停止预约"),$("#startReservationBtn").next().text("正在预约中...")):($("#startReservationBtn").removeClass("btn-warning").addClass("btn-primary").text("开始预约"),$("#startReservationBtn").next().text(""))})}function afterStarted(){chrome.storage.local.set({isRunning:isRunning},function(){updateState()})}function updateSetting(){chrome.storage.local.get("reservationDate",function(t){if(reservationDate=t.reservationDate)switch(reservationDate){case 7:$("#reservationDate").text("7天后 ("+moment().add(7,"days").format("M月D日")+")");break;case 6:$("#reservationDate").text("6天后 ("+moment().add(6,"days").format("M月D日")+")");break;case 5:$("#reservationDate").text("5天后 ("+moment().add(5,"days").format("M月D日")+")");break;case 4:$("#reservationDate").text("4天后 ("+moment().add(4,"days").format("M月D日")+")");break;case 3:$("#reservationDate").text("大后天 ("+moment().add(3,"days").format("M月D日")+")");break;case 2:$("#reservationDate").text("后天 ("+moment().add(2,"days").format("M月D日")+")");break;case 1:$("#reservationDate").text("明天 ("+moment().add(1,"days").format("M月D日")+")")}else $("#reservationDate").text("7天后 ("+moment().add(7,"days").format("M月D日")+")")}),chrome.storage.local.get("firstCoach",function(t){firstCoach=t.firstCoach,firstCoach?$("#firstCoach").text(firstCoach):$("#firstCoach").text("未填写")}),chrome.storage.local.get("secondCoach",function(t){secondCoach=t.secondCoach,secondCoach?$("#secondCoach").text(secondCoach):$("#secondCoach").text("未填写")}),chrome.storage.local.get("firstTime",function(t){firstTime=t.firstTime,firstTime?$("#firstTime").text(firstTime):$("#firstTime").text("未选择")}),chrome.storage.local.get("secondTime",function(t){secondTime=t.secondTime,secondTime?$("#secondTime").text(secondTime):$("#secondTime").text("未选择")}),chrome.storage.local.get("canTwoTime",function(t){canTwoTime=t.canTwoTime,canTwoTime?$("#canTwoTime").text("是"):$("#canTwoTime").text("否")})}function afterSaved(){updateSetting(),$("#saveSettingBtn").removeClass("btn-primary").addClass("btn-success").text("设置已保存"),setTimeout(function(){$("#saveSettingBtn").removeClass("btn-success").addClass("btn-primary").text("保存设置")},1e3)}function initDate(){$("#reservation_date").children("option").each(function(){switch($(this).val()){case"7":$(this).text("7天后 ("+moment().add(7,"days").format("M月D日")+")");break;case"6":$(this).text("6天后 ("+moment().add(6,"days").format("M月D日")+")");break;case"5":$(this).text("5天后 ("+moment().add(5,"days").format("M月D日")+")");break;case"4":$(this).text("4天后 ("+moment().add(4,"days").format("M月D日")+")");break;case"3":$(this).text("大后天 ("+moment().add(3,"days").format("M月D日")+")");break;case"2":$(this).text("后天 ("+moment().add(2,"days").format("M月D日")+")");break;case"1":$(this).text("明天 ("+moment().add(1,"days").format("M月D日")+")")}})}function isValid(t,e,a,s,n){$("#setting").children(".form-group").each(function(){$(this).removeClass("has-error"),$(this).find(".help-block").text("")});var o=!0,r=!0;return t?(!isChinese(t)||t.length<2||t.length>4)&&(o=!1,r=!1,$("#first_coach").next().text("第一教练名字不规范"),$("#first_coach").parent().parent().addClass("has-error")):(o=!1,r=!1,$("#first_coach").next().text("请填写第一教练"),$("#first_coach").parent().parent().addClass("has-error")),(e.length>1||e.length<5)&&(isChinese(e)?r&&t==e&&(o=!1,$("#second_coach").next().text("第二教练与第一教练不能相同"),$("#second_coach").parent().parent().addClass("has-error")):(o=!1,$("#second_coach").next().text("第二教练名字不规范"),$("#second_coach").parent().parent().addClass("has-error"))),a?s?a==s?(o=!1,$("#second_time").next().text("第二时段与第一时段不能相同"),$("#second_time").parent().parent().addClass("has-error")):n&&2==Math.abs(parseInt(a.substr(0,2))-parseInt(s.substr(0,2)))&&(o=!1,$("#second_time").next().text("两个时段不能连续"),$("#second_time").parent().parent().addClass("has-error")):n&&($("#second_time").next().text("请选择第二时段"),$("#second_time").parent().parent().addClass("has-error")):(o=!1,$("#first_time").next().text("请选择第一时段"),$("#first_time").parent().parent().addClass("has-error")),o}function isChinese(t){var e=/[^\u4e00-\u9fa5]/;return!e.test(t)}function showNotification(t,e){var a={type:"basic",title:t,message:e,iconUrl:"images/icon_48.png"};chrome.notifications.create("start",a,function(t){setTimeout(function(){chrome.notifications.clear(t)},5e3)})}var reservationDate,firstCoach,secondCoach,firstTime,secondTime,canTwoTime,isRunning;$(function(){updateSetting(),updateState(),initDate(),$("#startReservationBtn").on("click",function(){isRunning?(isRunning=!1,afterStarted()):reservationDate&&firstCoach&&firstTime?(isRunning=!0,afterStarted(),chrome.tabs.executeScript(null,{file:"lib/js/jquery.min.js"},function(){chrome.tabs.executeScript(null,{file:"dist/js/script.min.js"})})):showNotification("设置错误","请先设置教练和时段，再点击“开始预约”！")}),$("#saveSettingBtn").on("click",function(){var t=parseInt($("#reservation_date").val()),e=$("#first_coach").val(),a=$("#second_coach").val(),s=$("#first_time").val(),n=$("#second_time").val(),o=$("#can_two_time").prop("checked");if(isValid(e,a,s,n,o)){var r=0;chrome.storage.local.set({reservationDate:t},function(){r++,6==r&&afterSaved()}),chrome.storage.local.set({firstCoach:e},function(){r++,6==r&&afterSaved()}),chrome.storage.local.set({secondCoach:a},function(){r++,6==r&&afterSaved()}),chrome.storage.local.set({firstTime:s},function(){r++,6==r&&afterSaved()}),chrome.storage.local.set({secondTime:n},function(){r++,6==r&&afterSaved()}),chrome.storage.local.set({canTwoTime:o},function(){r++,6==r&&afterSaved()})}}),chrome.extension.onRequest.addListener(function(t,e,a){var s={};switch(t.type){case"-1":$.ajax({url:"http://zhjp.qingniao.tech",type:"post",dataType:"json",data:{drivingSchool:t.message,reservationDate:moment().add(reservationDate,"days").format("YYYY-MM-DD"),firstCoach:firstCoach,secondCoach:secondCoach,firstTime:firstTime,secondTime:secondTime,canTwoTime:canTwoTime?1:0},success:function(t){}}),s.type="-1",s.status="success";break;case"0":showNotification("页面错误","请先进入“培训预约”页面，再点击“开始预约”！"),s.type="0",s.status="success";break;case"1":showNotification("页面错误","请先选择科目进入具体页面，再点击“开始预约”！"),s.type="1",s.status="success";break;case"2":showNotification("预约失败","请更改教练或时段，重新点击“开始预约”！"),s.type="2",s.status="success";break;case"3":showNotification("预约成功","请前往“个人信息”-->“预约记录”查看确认！"),s.type="3",s.status="success"}updateState(),a(s)})});